---
  - name: install postgres
    apt: pkg=postgresql-9.3

  - name: install psycopg2
    apt: pkg=python-psycopg2

  - name: install postgis
    apt: pkg=postgis

  - name: install osm2pgsql
    apt: pkg=osm2pgsql

  - name: write postgres.conf file
    template: src=templates/postgresql.conf.j2 dest=/etc/postgresql/9.3/main/postgresql.conf
    notify: restart postgresql

  - name: write pg_hba.conf file
    template: src=templates/pg_hba.conf.j2 dest=/etc/postgresql/9.3/main/pg_hba.conf
    notify: restart postgresql

  - name: create .pgpass file
    template: src=templates/pgpass.j2 dest=~/.pgpass mode=0600
    sudo: no

  - name: create db user
    sudo_user: postgres
    postgresql_user: name={{ db_user }}
                     password={{ db_password }}
                     encrypted=false

  - name: create osm database
    sudo_user: postgres
    postgresql_db: name={{ db_name }} owner={{ db_user }}

  - name: enable postgis on osm database
    sudo_user: postgres
    command: psql -d {{ db_name }} -c 'CREATE EXTENSION IF NOT EXISTS postgis;'

  - name: enable hstore on osm database
    sudo_user: postgres
    command: psql -d {{ db_name }} -c 'CREATE EXTENSION IF NOT EXISTS hstore;'

  - name: download metro extracts
    get_url: url=https://s3.amazonaws.com/metro-extracts.mapzen.com/{{ item }}.osm.pbf dest=/tmp/{{ item }}.osm.pbf
    with_items: metro_extracts
    sudo: no

  - name: import metro first extract into database
    command: osm2pgsql  --create --slim --cache 200 --cache-strategy sparse --multi-geometry --host localhost --database {{ db_name }} --user {{ db_user }} /tmp/{{ item }}.osm.pbf
    with_items: metro_extracts|first
    sudo: no

  - name: import other metro extracts into database
    command: osm2pgsql  --append --slim --cache 200 --cache-strategy sparse --multi-geometry --host localhost --database {{ db_name }} --user {{ db_user }} /tmp/{{ item }}.osm.pbf
    with_items: metro_extracts[1:]
    sudo: no
